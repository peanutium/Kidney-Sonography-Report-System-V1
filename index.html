<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kidney Sonography Report System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState } = React;

    // ===== Utilities =====
    const mkArray = (n) => Array.from({ length: n }, () => "");
    const parseNumber = (s) => {
      if (!s) return null;
      const m = String(s).replace(/,/g, ".").match(/\d*\.?\d+/);
      if (!m) return null;
      const num = parseFloat(m[0]);
      return Number.isFinite(num) ? num : null;
    };
    const cleanList = (arr) => arr.map(parseNumber).filter((v) => v !== null);
    const pluralize = (word, count) => (count === 1 ? word : word + "s");
    const countWord = (n) => {
      const words = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen","Twenty"]; 
      return (n >= 0 && n < words.length) ? words[n] : String(n);
    };
    // Oxford-comma list for diameters: "5.6cm, 5.7cm, and 6.5cm"
    const joinWithCommasAndAnd = (nums) => {
      if (!nums || nums.length === 0) return "";
      const formatted = nums.map((n) => `${n}cm`);
      if (formatted.length === 1) return formatted[0];
      if (formatted.length === 2) return `${formatted[0]} and ${formatted[1]}`;
      return `${formatted.slice(0, -1).join(", ")}, and ${formatted[formatted.length - 1]}`;
    };
    const normalizeSize = (raw) => {
      if (!raw || !raw.trim()) return "";
      const s = raw.replace(/cm/gi, "");
      const m = s.match(/(\d*\.?\d+)\s*[x×]\s*(\d*\.?\d+)/i);
      if (m) return `${m[1]}x${m[2]}cm`;
      const trimmed = s.trim().replace(/\s+/g, " ");
      return `${trimmed}${/cm$/i.test(trimmed) ? "" : " cm"}`;
    };

    function Section({ title, children }) {
      return (
        <div className="bg-white/80 rounded-2xl shadow p-5 border border-gray-100">
          <h2 className="text-lg font-semibold mb-3">{title}</h2>
          {children}
        </div>
      );
    }

    function LesionGrid({ title, arr, setArr }) {
      const onArrayChange = (idx, val) => {
        const next = [...arr];
        next[idx] = val;
        setArr(next);
      };
      return (
        <div>
          <div className="text-sm text-gray-700 mb-2">{title} (up to 7; free text numbers like 7.53)</div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
            {arr.map((v, i) => (
              <input
                key={i}
                type="text"
                inputMode="decimal"
                value={v}
                onChange={(e) => onArrayChange(i, e.target.value)}
                placeholder={`#${i + 1}`}
                className="rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300"
              />
            ))}
          </div>
          <div className="mt-1 text-xs text-gray-500">Leave blanks if none. We auto-count and pluralize; decimals like 7.53 are fine.</div>
        </div>
      );
    }

    function App() {
      // (1) Kidney size: single free-text per side, e.g., "10.2 x 4.1 cm"
      const [rkSizeRaw, setRkSizeRaw] = useState("");
      const [lkSizeRaw, setLkSizeRaw] = useState("");

      // Qualitative features
      const [prominentSinus, setProminentSinus] = useState(false);
      const [cortexThickness, setCortexThickness] = useState("normal");
      const [echogenicity, setEchogenicity] = useState("normal");

      // Lesions (7 slots each)
      const [rkHypo, setRkHypo] = useState(mkArray(7));
      const [rkHyper, setRkHyper] = useState(mkArray(7));
      const [lkHypo, setLkHypo] = useState(mkArray(7));
      const [lkHyper, setLkHyper] = useState(mkArray(7));

      // Derived arrays
      const rkHypoNums = useMemo(() => cleanList(rkHypo), [rkHypo]);
      const rkHyperNums = useMemo(() => cleanList(rkHyper), [rkHyper]);
      const lkHypoNums = useMemo(() => cleanList(lkHypo), [lkHypo]);
      const lkHyperNums = useMemo(() => cleanList(lkHyper), [lkHyper]);

      const rkHypoCount = rkHypoNums.length;
      const rkHyperCount = rkHyperNums.length;
      const lkHypoCount = lkHypoNums.length;
      const lkHyperCount = lkHyperNums.length;

      const anyStone = rkHyperCount + lkHyperCount > 0;
      const anyCystOrMass = rkHypoCount + lkHypoCount > 0;

      const findings = useMemo(() => {
        const lines = [];
        const rkOut = normalizeSize(rkSizeRaw);
        const lkOut = normalizeSize(lkSizeRaw);
        lines.push(`- The right kidney measures ${rkOut || ""}${rkOut ? "," : ""} and the left ${lkOut || ""}.`);

        const sinusPart = prominentSinus ? "Prominent renal sinus; " : "";
        const cortexPart = `${cortexThickness} cortex thickness`;
        const echoPart = `with ${echogenicity} echogenicity of both kidneys`;
        lines.push(`- ${sinusPart}${cortexPart} ${echoPart}.`);

        if (rkHypoCount > 0) {
          const nWord = countWord(rkHypoCount);
          lines.push(`- ${nWord} hypoechoic ${pluralize("lesion", rkHypoCount)} at right kidney, diameter ${joinWithCommasAndAnd(rkHypoNums)}, right renal ${pluralize("cyst", rkHypoCount)}.`);
        }
        if (rkHyperCount > 0) {
          const nWord = countWord(rkHyperCount);
          lines.push(`- ${nWord} hyperechoic ${pluralize("lesion", rkHyperCount)} at right kidney, diameter ${joinWithCommasAndAnd(rkHyperNums)}, right renal ${pluralize("stone", rkHyperCount)}.`);
        }
        if (lkHypoCount > 0) {
          const nWord = countWord(lkHypoCount);
          lines.push(`- ${nWord} hypoechoic ${pluralize("lesion", lkHypoCount)} at left kidney, diameter ${joinWithCommasAndAnd(lkHypoNums)}, left renal ${pluralize("cyst", lkHypoCount)}.`);
        }
        if (lkHyperCount > 0) {
          const nWord = countWord(lkHyperCount);
          lines.push(`- ${nWord} hyperechoic ${pluralize("lesion", lkHyperCount)} at left kidney, diameter ${joinWithCommasAndAnd(lkHyperNums)}, left renal ${pluralize("stone", lkHyperCount)}.`);
        }

        if (!anyStone) lines.push(`- No renal stone or hydronephrosis.`);
        if (!anyCystOrMass) lines.push(`- No cystic or mass lesion.`);
        return lines.join("\n");
      }, [rkSizeRaw, lkSizeRaw, prominentSinus, cortexThickness, echogenicity, rkHypoCount, rkHyperCount, lkHypoCount, lkHyperCount, rkHypoNums, rkHyperNums, lkHypoNums, lkHyperNums, anyStone, anyCystOrMass]);

      const impression = useMemo(() => {
        const items = [];
        const normalKidneys = cortexThickness === "normal" && echogenicity === "normal";
        const noLesions = !anyStone && !anyCystOrMass && !prominentSinus;
        if (normalKidneys && noLesions) items.push("Unremarkable renal sonography");
        if (echogenicity === "increased") items.push("Chronic renal parenchymal disease of both kidneys");
        if (rkHypoCount > 0) items.push(`Right renal ${pluralize("cyst", rkHypoCount)}`);
        if (rkHyperCount > 0) items.push(`Right renal ${pluralize("stone", rkHyperCount)}`);
        if (lkHypoCount > 0) items.push(`Left renal ${pluralize("cyst", lkHypoCount)}`);
        if (lkHyperCount > 0) items.push(`Left renal ${pluralize("stone", lkHyperCount)}`);
        return items.join("\n");
      }, [cortexThickness, echogenicity, rkHypoCount, rkHyperCount, lkHypoCount, lkHyperCount, anyStone, anyCystOrMass, prominentSinus]);

      const copyToClipboard = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          alert("Copied to clipboard!");
        } catch (e) {
          alert("Copy failed. You can select and copy manually.");
        }
      };

      const downloadTxt = (filename, text) => {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const resetAll = () => {
        setRkSizeRaw("");
        setLkSizeRaw("");
        setProminentSinus(false);
        setCortexThickness("normal");
        setEchogenicity("normal");
        setRkHypo(mkArray(7));
        setRkHyper(mkArray(7));
        setLkHypo(mkArray(7));
        setLkHyper(mkArray(7));
      };

      return (
        <div className="max-w-6xl mx-auto p-6">
          <header className="mb-6">
            <h1 className="text-2xl md:text-3xl font-bold">Kidney Sonography Report System</h1>
            <p className="text-sm text-gray-600 mt-1">Free-text inputs (decimals like 7.53 OK). Sizes output as “AxBcm”.</p>
          </header>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
            <div className="lg:col-span-2 space-y-4">
              <Section title="Kidney Measurements (free text)">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <label className="text-sm">
                    <div className="font-medium text-gray-700 mb-1">Right kidney</div>
                    <input
                      type="text"
                      inputMode="text"
                      value={rkSizeRaw}
                      onChange={(e) => setRkSizeRaw(e.target.value)}
                      placeholder="e.g., 10.6 x 4.2 cm"
                      className="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300"
                    />
                    <div className="text-xs text-gray-500 mt-1">Format examples: 10x4.2 cm, 10.6 × 4.2, 10.6x4.2cm</div>
                  </label>
                  <label className="text-sm">
                    <div className="font-medium text-gray-700 mb-1">Left kidney</div>
                    <input
                      type="text"
                      inputMode="text"
                      value={lkSizeRaw}
                      onChange={(e) => setLkSizeRaw(e.target.value)}
                      placeholder="e.g., 10.2 x 4.0 cm"
                      className="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300"
                    />
                    <div className="text-xs text-gray-500 mt-1">Any spacing is fine—we normalize to AxBcm.</div>
                  </label>
                </div>
              </Section>

              <Section title="Parenchymal Features">
                <div className="flex flex-wrap items-center gap-4">
                  <label className="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox" className="rounded" checked={prominentSinus} onChange={(e) => setProminentSinus(e.target.checked)} />
                    <span>Prominent renal sinus</span>
                  </label>
                  <label className="text-sm inline-flex items-center gap-2">
                    Cortex thickness
                    <select value={cortexThickness} onChange={(e) => setCortexThickness(e.target.value)} className="rounded-xl border border-gray-300 px-2 py-1">
                      <option value="normal">normal</option>
                      <option value="thinning">thinning</option>
                    </select>
                  </label>
                  <label className="text-sm inline-flex items-center gap-2">
                    Echogenicity
                    <select value={echogenicity} onChange={(e) => setEchogenicity(e.target.value)} className="rounded-xl border border-gray-300 px-2 py-1">
                      <option value="normal">normal</option>
                      <option value="increased">increased</option>
                    </select>
                  </label>
                </div>
              </Section>

              <Section title="Lesions">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <LesionGrid title="Right kidney hypoechoic lesions (cysts)" arr={rkHypo} setArr={setRkHypo} />
                  <LesionGrid title="Right kidney HYPERechoic lesions (stones)" arr={rkHyper} setArr={setRkHyper} />
                  <LesionGrid title="Left kidney hypoechoic lesions (cysts)" arr={lkHypo} setArr={setLkHypo} />
                  <LesionGrid title="Left kidney HYPERechoic lesions (stones)" arr={lkHyper} setArr={setLkHyper} />
                </div>
              </Section>

              <div className="flex gap-3">
                <button onClick={resetAll} className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200 border">Reset</button>
              </div>
            </div>

            <div className="space-y-4">
              <Section title="Sonographic findings (auto-generated)">
                <pre className="whitespace-pre-wrap text-sm leading-6 bg-slate-50 rounded-xl p-3 border overflow-auto max-h-[340px]">{findings}</pre>
                <div className="flex gap-2 mt-2">
                  <button onClick={() => copyToClipboard(findings)} className="px-3 py-2 rounded-2xl bg-indigo-600 text-white hover:bg-indigo-700">Copy findings</button>
                  <button onClick={() => downloadTxt("sonographic_findings.txt", findings)} className="px-3 py-2 rounded-2xl bg-white border hover:bg-gray-50">Download .txt</button>
                </div>
              </Section>
              <Section title="Impression (auto-generated)">
                <pre className="whitespace-pre-wrap text-sm leading-6 bg-slate-50 rounded-xl p-3 border overflow-auto max-h-[300px]">{impression}</pre>
                <div className="flex gap-2 mt-2">
                  <button onClick={() => copyToClipboard(impression)} className="px-3 py-2 rounded-2xl bg-indigo-600 text-white hover:bg-indigo-700">Copy impression</button>
                  <button onClick={() => downloadTxt("impression.txt", impression)} className="px-3 py-2 rounded-2xl bg-white border hover:bg-gray-50">Download .txt</button>
                </div>
              </Section>

              <div className="text-xs text-gray-500">
                Notes:
                <ul className="list-disc ml-4 mt-1 space-y-1">
                  <li>Kidney sizes accept any free-text like <em>10.6 x 4.2 cm</em>, <em>10.6×4.2</em>, or <em>10.6x4.2cm</em>. Output is normalized to <strong>AxBcm</strong>.</li>
                  <li>Decimals (e.g., 7.53) are fully supported everywhere.</li>
                  <li>Counts are written in words (e.g., “One”, “Two”). Diameters list uses commas with ", and" before the last value.</li>
                </ul>
              </div>
            </div>
          </div>

          <footer className="mt-8 text-center text-xs text-gray-500">
            © {new Date().getFullYear()} Kidney Sonography Report System — Ready for GitHub Pages deployment.
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
